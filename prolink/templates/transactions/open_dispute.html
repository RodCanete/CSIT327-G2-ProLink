<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Dispute - ProLink</title>
    <link rel="stylesheet" href="{% static 'css/colors.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=4">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    .file-upload-area {
        position: relative;
        border: 2px dashed var(--gray-300);
        border-radius: var(--border-radius);
        padding: 30px 20px;
        text-align: center;
        background: var(--gray-50);
        cursor: pointer;
        transition: var(--transition-fast);
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: var(--gray-100);
    }
    
    .file-upload-area i {
        font-size: 48px;
        color: var(--secondary-color);
        margin-bottom: 10px;
        display: block;
    }
    
    .file-upload-content {
        pointer-events: none;
    }
    
    .file-upload-content h4 {
        color: var(--dark-color);
        margin: 10px 0;
    }
    
    .file-upload-content p {
        color: var(--gray-600);
        margin: 5px 0;
    }
    
    .file-upload-link {
        pointer-events: all;
        color: var(--primary-color);
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
    }
    
    .file-upload-info {
        margin-top: 10px;
        color: var(--gray-500);
        font-size: 12px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 120px;
    }
    
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .btn-submit-dispute {
        background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-submit-dispute:hover {
        transform: translateY(-2px);
        box-shadow: var(--box-shadow-lg);
    }
    
    .warning-box {
        background: #fff3cd;
        border-left: 4px solid var(--warning-color);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
    }
    
    .warning-box h4 {
        color: var(--warning-color);
        margin-bottom: 10px;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .warning-box ul {
        margin: 8px 0 0 20px;
        font-size: 13px;
        line-height: 1.6;
        color: var(--gray-700);
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-item .info-label {
        font-weight: 600;
        color: var(--gray-700);
    }
    
    .info-item .info-value {
        color: var(--gray-600);
        text-align: right;
    }
    </style>
</head>
<body>
    {% include 'components/navbar.html' %}

    <main class="main-content">
        <div class="dashboard-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">
                    <h1>Open a Dispute</h1>
                    <p>File a dispute for request: {{ service_request.title }}</p>
                </div>
                <div class="page-actions">
                    <a href="{% url 'request_detail' service_request.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Request
                    </a>
                </div>
            </div>

            <!-- Dispute Form Container -->
            <div class="request-detail-container">
                <div class="request-detail-grid">
                    <!-- Main Content -->
                    <div class="request-detail-main">
                        <!-- Important Notice -->
                        <div class="detail-section">
                            <h3 class="detail-section-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Important Notice
                            </h3>
                            <div class="detail-content">
                                <div class="warning-box">
                                    <ul>
                                        <li>Opening a dispute will freeze the transaction immediately</li>
                                        <li>An administrator will review your case within 24-48 hours</li>
                                        <li>Provide detailed evidence to support your claim</li>
                                        <li>The admin's decision is final</li>
                                        <li>Possible outcomes: Full refund to you OR Full payment to professional</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Dispute Form -->
                        <form method="POST" enctype="multipart/form-data" id="disputeForm">
                            {% csrf_token %}
                            
                            <!-- Reason for Dispute -->
                            <div class="detail-section">
                                <h3 class="detail-section-title">
                                    <i class="fas fa-clipboard-list"></i>
                                    Reason for Dispute *
                                </h3>
                                <div class="detail-content">
                                    <div class="form-group">
                                        <label for="reason">
                                            Please provide a detailed explanation of why you're opening this dispute
                                            <small style="font-weight: normal; color: var(--gray-600); display: block; margin-top: 4px;">(Minimum 50 characters)</small>
                                        </label>
                                        <textarea 
                                            name="reason" 
                                            id="reason" 
                                            rows="6" 
                                            required 
                                            minlength="50"
                                            placeholder="Please provide a detailed explanation of why you're opening this dispute...&#10;&#10;Examples:&#10;- Work does not match the requirements&#10;- Professional not responding to revision requests&#10;- Quality is significantly below expectations&#10;- Deliverables are incomplete or missing"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Evidence -->
                            <div class="detail-section">
                                <h3 class="detail-section-title">
                                    <i class="fas fa-file-alt"></i>
                                    Additional Evidence
                                </h3>
                                <div class="detail-content">
                                    <div class="form-group">
                                        <label for="client_evidence">
                                            Additional details, timeline of events, previous communication, etc.
                                            <small style="font-weight: normal; color: var(--gray-600); display: block; margin-top: 4px;">(Optional - provide more context)</small>
                                        </label>
                                        <textarea 
                                            name="client_evidence" 
                                            id="client_evidence" 
                                            rows="5"
                                            placeholder="Additional details, timeline of events, previous communication, etc."
                                        ></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Evidence Files -->
                            <div class="detail-section">
                                <h3 class="detail-section-title">
                                    <i class="fas fa-paperclip"></i>
                                    Upload Evidence Files
                                </h3>
                                <div class="detail-content">
                                    <div class="form-group">
                                        <label>
                                            Upload supporting documents, screenshots, or other evidence
                                            <small style="font-weight: normal; color: var(--gray-600); display: block; margin-top: 4px;">(Optional - Maximum 5 files, 10MB each)</small>
                                        </label>
                                        <div class="file-upload-area" id="clientFileUploadArea">
                                            <div class="file-upload-content">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                <h4 style="margin: 10px 0; font-size: 16px;">Drag & drop files here</h4>
                                                <p>or <span class="file-upload-link" style="color: var(--primary-color); cursor: pointer; text-decoration: underline;">browse files</span></p>
                                                <div class="file-upload-info">
                                                    <small>Maximum 5 files, 10MB each</small>
                                                    <br>
                                                    <small>Supported: PDF, PNG, JPG, DOC, DOCX</small>
                                                </div>
                                            </div>
                                            <input 
                                                type="file" 
                                                name="evidence_files" 
                                                id="evidence_files" 
                                                class="file-input"
                                                multiple 
                                                accept=".pdf,.png,.jpg,.jpeg,.doc,.docx"
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
                                                onchange="showFileNames()"
                                            >
                                        </div>
                                        <div id="fileNames" style="margin-top: 8px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Before Submitting -->
                            <div class="detail-section">
                                <h3 class="detail-section-title">
                                    <i class="fas fa-check-circle"></i>
                                    Before Submitting
                                </h3>
                                <div class="detail-content">
                                    <div class="warning-box">
                                        <ul>
                                            <li>Have you tried requesting revisions? (You can request up to {{ service_request.max_revisions }})</li>
                                            <li>Have you communicated clearly with the professional?</li>
                                            <li>Do you have sufficient evidence to support your claim?</li>
                                            <li>Are you prepared for the dispute process (24-48 hours)?</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons" style="display: flex; gap: 15px; margin-top: 30px;">
                                <a href="{% url 'request_detail' service_request.id %}" class="btn btn-secondary" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 14px 24px; text-decoration: none;">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="button" class="btn-submit-dispute" style="flex: 1;" onclick="showDisputeModal()">
                                    <i class="fas fa-gavel"></i> Open Dispute
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Sidebar -->
                    <div class="request-detail-sidebar">
                        <!-- Transaction Details -->
                        <div class="detail-card">
                            <h4>Transaction Details</h4>
                            <div class="info-item">
                                <span class="info-label">Professional</span>
                                <span class="info-value">{{ service_request.professional }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Amount</span>
                                <span class="info-value">₱{{ transaction.amount|floatformat:2 }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status</span>
                                <span class="info-value">{{ transaction.get_status_display }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Payment Date</span>
                                <span class="info-value">{{ transaction.paid_at|date:"M d, Y" }}</span>
                            </div>
                        </div>

                        <!-- Request Information -->
                        <div class="detail-card">
                            <h4>Request Information</h4>
                            <div class="info-item">
                                <span class="info-label">Request ID</span>
                                <span class="info-value">#{{ service_request.id }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Title</span>
                                <span class="info-value" style="text-align: right; word-break: break-word;">{{ service_request.title|truncatewords:10 }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status</span>
                                <span class="info-value">{{ service_request.get_status_display }}</span>
                            </div>
                            {% if service_request.max_revisions %}
                            <div class="info-item">
                                <span class="info-label">Max Revisions</span>
                                <span class="info-value">{{ service_request.max_revisions }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Dispute Confirmation Modal -->
    <div id="disputeConfirmModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 20px;"></i>
            <h3>Open Dispute</h3>
            <p>Are you sure you want to open a dispute? This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="hideDisputeModal()">Cancel</button>
                <button type="button" class="modal-btn modal-btn-danger" onclick="submitDisputeForm()">
                    <i class="fas fa-gavel"></i> Open Dispute
                </button>
            </div>
        </div>
    </div>

    <script>
    // Client file upload with drag and drop
    const clientFileUploadArea = document.getElementById('clientFileUploadArea');
    const clientFileInput = document.getElementById('evidence_files');
    
    if (clientFileUploadArea && clientFileInput) {
        // Click to upload
        clientFileUploadArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('file-upload-link') || e.target.closest('.file-upload-content')) {
                clientFileInput.click();
            }
        });
        
        // Drag and drop
        clientFileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            clientFileUploadArea.style.borderColor = 'var(--primary-color)';
            clientFileUploadArea.style.background = 'var(--gray-100)';
        });
        
        clientFileUploadArea.addEventListener('dragleave', () => {
            clientFileUploadArea.style.borderColor = 'var(--gray-300)';
            clientFileUploadArea.style.background = 'var(--gray-50)';
        });
        
        clientFileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            clientFileUploadArea.style.borderColor = 'var(--gray-300)';
            clientFileUploadArea.style.background = 'var(--gray-50)';
            
            clientFileInput.files = e.dataTransfer.files;
            showFileNames();
        });
        
        clientFileInput.addEventListener('change', showFileNames);
    }
    
    function showFileNames() {
        const input = document.getElementById('evidence_files');
        const fileNamesDiv = document.getElementById('fileNames');
        
        if (input.files.length === 0) {
            fileNamesDiv.innerHTML = '';
            return;
        }
        
        // Check file count
        if (input.files.length > 5) {
            fileNamesDiv.innerHTML = '<div style="padding: 12px; background: #fee2e2; border: 1px solid #dc2626; border-radius: var(--border-radius); color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> <strong>Maximum 5 files allowed.</strong> Please remove ' + (input.files.length - 5) + ' file(s).</div>';
            return;
        }
        
        let html = '<div style="padding: 15px; background: white; border: 1px solid var(--gray-200); border-radius: var(--border-radius); margin-top: 10px;">';
        html += '<strong style="color: var(--primary-color); display: block; margin-bottom: 10px;"><i class="fas fa-check-circle"></i> ✓ ' + input.files.length + ' file(s) selected:</strong>';
        html += '<ul style="list-style: none; padding: 0; margin: 0;">';
        
        Array.from(input.files).forEach(file => {
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            const isTooBig = file.size > 10 * 1024 * 1024;
            const sizeColor = isTooBig ? '#dc2626' : 'var(--gray-600)';
            const warningIcon = isTooBig ? '<i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i> ' : '';
            
            html += '<li style="padding: 8px 0; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;">';
            html += '<span style="color: var(--dark-color);"><i class="fas fa-file" style="color: var(--primary-color); margin-right: 8px;"></i>' + file.name + '</span>';
            html += '<span style="color: ' + sizeColor + '; font-size: 12px;">' + warningIcon + sizeMB + ' MB</span>';
            html += '</li>';
        });
        
        html += '</ul></div>';
        fileNamesDiv.innerHTML = html;
    }

    function showDisputeModal() {
        // Validate form before showing modal
        const reason = document.getElementById('reason').value.trim();
        if (!reason || reason.length < 50) {
            alert('Please provide a detailed reason for the dispute (minimum 50 characters).');
            document.getElementById('reason').focus();
            return;
        }
        
        const modal = document.getElementById('disputeConfirmModal');
        modal.classList.add('active');
    }

    function hideDisputeModal() {
        const modal = document.getElementById('disputeConfirmModal');
        modal.classList.remove('active');
    }

    function submitDisputeForm() {
        document.getElementById('disputeForm').submit();
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('disputeConfirmModal');
        if (event.target == modal) {
            hideDisputeModal();
        }
    }
    </script>
</body>
</html>
