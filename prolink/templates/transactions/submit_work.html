<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Submit Work - ProLink</title>
	<link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=4">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    {% include 'components/navbar.html' %}

    <main class="main-content">
        <div class="dashboard-content">
            <div class="page-header">
                <div class="page-title">
                    <h1>Submit Work</h1>
                    <p>Request: {{ service_request.title }}</p>
                </div>
                <div class="page-actions">
                    <a href="{% url 'professional_request_detail' service_request.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Details
                    </a>
                </div>
            </div>

			<div class="panel">
				<div class="panel-header">
					<h3><i class="fas fa-paper-plane"></i> Deliverables</h3>
					<span class="panel-subtitle">Payment is in escrow. Submitting marks this request for client review.</span>
				</div>
				<div class="panel-content">
					<form method="post" enctype="multipart/form-data" class="request-form" id="submitForm" style="display: grid; gap: 16px;">
						{% csrf_token %}

						<div>
							<label class="form-label" for="deliverable_notes">Release Notes / Summary</label>
							<textarea id="deliverable_notes" name="deliverable_notes" class="form-textarea" rows="6" placeholder="Describe what you delivered, how to test/use, known limitations, etc." required></textarea>
						</div>

						<div class="form-section">
							<h3 class="form-section-title">
								<i class="fas fa-paperclip"></i>
								File Attachments
							</h3>
							<div class="form-group">
								<label for="deliverable_files" class="form-label">Upload Files (Required)</label>
								<div class="file-upload-area" id="fileUploadArea">
									<div class="file-upload-content">
										<i class="fas fa-cloud-upload-alt"></i>
										<h4>Drag & drop files here</h4>
										<p>or <span class="file-upload-link">browse files</span></p>
										<div class="file-upload-info">
											<small>Maximum 5 files, 10MB each</small>
											<br>
											<small>Supported: PDF, DOC, DOCX, PNG, JPG, ZIP</small>
										</div>
									</div>
									<input type="file"
										   id="deliverable_files"
										   name="deliverable_files"
										   class="file-input"
										   multiple
										   accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.zip">
								</div>
								<div id="file-list" class="file-list"></div>
							</div>
						</div>

						<div class="form-actions">
							<a class="btn btn-secondary" href="{% url 'professional_request_detail' service_request.id %}">
								<i class="fas fa-times"></i>
								Cancel
							</a>
							<button type="submit" class="btn btn-primary" id="submitBtn">
								<i class="fas fa-paper-plane"></i>
								Submit for Review
							</button>
						</div>
					</form>
				</div>
			</div>
			<!-- Removed extra panels: What happens next & Debug Info -->
        </div>
    </main>

	<!-- Removed upload progress and success modals -->

	<script>
		// Drag & drop and multi-file handling (mirrors create_request)
		const fileUploadArea = document.getElementById('fileUploadArea');
		const fileInput = document.getElementById('deliverable_files');
		const fileList = document.getElementById('file-list');

		fileUploadArea.addEventListener('click', (e) => {
			if (e.target !== fileInput) fileInput.click();
		});
		fileUploadArea.addEventListener('dragover', (e) => {
			e.preventDefault();
			fileUploadArea.classList.add('drag-over');
		});
		fileUploadArea.addEventListener('dragleave', () => {
			fileUploadArea.classList.remove('drag-over');
		});
		fileUploadArea.addEventListener('drop', (e) => {
			e.preventDefault();
			fileUploadArea.classList.remove('drag-over');
			fileInput.files = e.dataTransfer.files;
			updateFileList();
		});

		let selectedFiles = [];
		fileInput.addEventListener('change', (e) => {
			const newFiles = Array.from(e.target.files);
			newFiles.forEach(file => {
				const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
				if (!exists && selectedFiles.length < 5) selectedFiles.push(file);
			});
			const dataTransfer = new DataTransfer();
			selectedFiles.forEach(file => dataTransfer.items.add(file));
			fileInput.files = dataTransfer.files;
			updateFileList();
			if (newFiles.length + selectedFiles.length > 5) {
				alert('Maximum 5 files allowed. Some files were not added.');
			}
		});

		function updateFileList() {
			fileList.innerHTML = '';
			if (selectedFiles.length === 0) {
				fileList.style.display = 'none';
				return;
			}
			fileList.style.display = 'block';
			selectedFiles.forEach((file, index) => {
				const item = document.createElement('div');
				item.className = 'file-item';
				item.innerHTML = `
					<div class="file-info">
						<i class="fas fa-file"></i>
						<span class="file-name">${file.name}</span>
						<span class="file-size">(${formatFileSize(file.size)})</span>
					</div>
					<button type="button" class="file-remove" onclick="removeFile(${index})">
						<i class="fas fa-times"></i>
					</button>
				`;
				fileList.appendChild(item);
			});
		}

		function removeFile(index) {
			selectedFiles.splice(index, 1);
			const dataTransfer = new DataTransfer();
			selectedFiles.forEach(file => dataTransfer.items.add(file));
			fileInput.files = dataTransfer.files;
			updateFileList();
		}

		function formatFileSize(bytes) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
		}

		// Progress + AJAX submit (mirrors create_request)
		const requestForm = document.getElementById('submitForm');
		const submitBtn = document.getElementById('submitBtn');

		requestForm.addEventListener('submit', function(e) {
			const notes = document.getElementById('deliverable_notes').value.trim();
			const files = fileInput.files;

			if (notes.length < 5) {
				e.preventDefault();
				alert('Please provide more detailed deliverable notes.');
				return;
			}
			if (!files || files.length === 0) {
				e.preventDefault();
				alert('Please attach at least one file.');
				return;
			}
			// Basic UX: disable submit to prevent double submits
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
		});
	</script>
</body>
</html>
